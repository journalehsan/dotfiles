#!/bin/bash

# This script updates Arch Linux system packages and AUR packages through a SOCKS5 proxy
# It requires an active Shadowsocks SOCKS5 server on 127.0.0.1:1080

set -e  # Exit on error

PROXY_HOST="127.0.0.1"
PROXY_PORT="1080"

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if Shadowsocks proxy is accessible
check_proxy() {
    if timeout 2 bash -c "echo >/dev/tcp/$PROXY_HOST/$PROXY_PORT" 2>/dev/null; then
        echo -e "${GREEN}✓ Proxy is accessible at $PROXY_HOST:$PROXY_PORT${NC}"
        return 0
    else
        echo -e "${RED}✗ Cannot connect to proxy at $PROXY_HOST:$PROXY_PORT${NC}"
        echo -e "${YELLOW}Make sure Shadowsocks client is running.${NC}"
        return 1
    fi
}

# Export proxy environment variables
export_proxy() {
    export ALL_PROXY=socks5://$PROXY_HOST:$PROXY_PORT
    export HTTP_PROXY=socks5://$PROXY_HOST:$PROXY_PORT
    export HTTPS_PROXY=socks5://$PROXY_HOST:$PROXY_PORT
    export SOCKS5_PROXY=socks5://$PROXY_HOST:$PROXY_PORT
}

# Update system packages
update_system() {
    echo -e "${YELLOW}Updating Arch Linux system packages...${NC}"
    sudo pacman -Syu --noconfirm || {
        echo -e "${RED}System update failed${NC}"
        return 1
    }
    echo -e "${GREEN}✓ System packages updated${NC}"
}

# Update AUR packages using yay
update_aur() {
    if ! command -v yay &> /dev/null; then
        echo -e "${YELLOW}yay is not installed. Skipping AUR update.${NC}"
        return 0
    fi

    echo -e "${YELLOW}Updating AUR packages...${NC}"
    yay -Sua --noconfirm || {
        echo -e "${RED}AUR update failed${NC}"
        return 1
    }
    echo -e "${GREEN}✓ AUR packages updated${NC}"
}

# Main execution
main() {
    echo -e "${GREEN}=== Arch Linux System and AUR Update with Proxy ===${NC}"
    echo "Proxy: $PROXY_HOST:$PROXY_PORT"
    echo ""

    # Check proxy connectivity
    if ! check_proxy; then
        exit 1
    fi

    # Export proxy settings
    export_proxy
    echo -e "${GREEN}✓ Proxy environment variables set${NC}"
    echo ""

    # Update system packages
    if ! update_system; then
        exit 1
    fi
    echo ""

    # Update AUR packages
    if ! update_aur; then
        exit 1
    fi
    echo ""

    echo -e "${GREEN}=== Update Complete ===${NC}"
}

# Run main function
main "$@"
